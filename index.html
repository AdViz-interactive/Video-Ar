<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"><title>AdViz AR</title><style>body{margin:0;overflow:hidden;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Arial;background-color:#111;color:white;touch-action:none;user-select:none}#overlay{position:absolute;top:0;left:0;width:100%;height:100%;pointer-events:none;display:flex;flex-direction:column;justify-content:center;align-items:center;z-index:100}#setup-panel{pointer-events:auto;background:rgba(20,20,20,0.95);padding:24px;border-radius:16px;text-align:center;border:1px solid rgba(255,255,255,0.1);max-width:85%;box-shadow:0 10px 40px rgba(0,0,0,0.6)}h1{margin:0 0 10px 0;font-size:1.4rem}p{color:#aaa;margin-bottom:20px;font-size:0.9rem}.btn-primary{background-color:#4f46e5;color:white;padding:12px 24px;border-radius:8px;font-weight:600;border:none;cursor:pointer;font-size:1rem}.file-wrapper{position:relative;display:inline-block;overflow:hidden;margin-bottom:15px}.file-wrapper input[type=file]{font-size:100px;position:absolute;left:0;top:0;opacity:0;cursor:pointer}#status-msg{margin-top:15px;font-size:0.9rem;color:#888}.success{color:#4ade80!important;font-weight:bold}#ar-btn-container{margin-top:20px;height:50px;display:flex;justify-content:center;pointer-events:auto}button#ARButton{position:static!important;padding:12px 30px!important;font-size:16px!important;border-radius:8px!important;background-color:#22c55e!important;color:white!important}#feedback{position:absolute;top:15%;background:rgba(0,0,0,0.7);padding:10px 20px;border-radius:30px;font-size:14px;pointer-events:none;opacity:0;transition:opacity 0.3s;z-index:102}#feedback.visible{opacity:1}#gesture-hint{position:absolute;bottom:20px;left:50%;transform:translateX(-50%);background:rgba(0,0,0,0.7);padding:10px 20px;border-radius:20px;font-size:12px;pointer-events:none;opacity:0;transition:opacity 0.3s;z-index:102}#gesture-hint.visible{opacity:1}</style></head><body><div id="overlay"><div id="setup-panel"><h1>AdViz Smart AR</h1><p>Upload video, tap AR, place on walls/floors</p><div class="file-wrapper"><button class="btn-primary">üìÅ Choose Video</button><input type="file" id="video-input" accept="video/*"></div><div id="status-msg">Waiting for video...</div><div id="ar-btn-container"></div></div><div id="feedback">Scanning...</div><div id="gesture-hint" class="visible">Pinch to scale ‚Ä¢ Rotate to spin ‚Ä¢ Tap to play</div></div><video id="video-source" loop muted playsinline webkit-playsinline crossorigin="anonymous" style="display:none"></video><script type="importmap">{"imports":{"three":"https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js","three/addons/":"https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/"}}</script><script type="module">import * as THREE from 'three';import {ARButton} from 'three/addons/webxr/ARButton.js';let scene,camera,renderer,controller,reticle,videoMesh,videoElement,isPlaced=false,surfaceType='floor',videoAspect=1.77,videoHeight=1.0;const raycaster=new THREE.Raycaster(),tempMatrix=new THREE.Matrix4();let touchDist0=0,startScale=1,pinching=false,lastRotZ=0;const elFeedback=document.getElementById('feedback'),elGesture=document.getElementById('gesture-hint'),elStatus=document.getElementById('status-msg'),elArBtn=document.getElementById('ar-btn-container'),elSetup=document.getElementById('setup-panel');init();function init(){const container=document.createElement('div');document.body.appendChild(container);scene=new THREE.Scene();scene.background=null;camera=new THREE.PerspectiveCamera(70,innerWidth/innerHeight,0.01,20);const light=new THREE.HemisphereLight(0xffffff,0xbbbbff,3);light.position.set(0.5,1,0.25);scene.add(light);renderer=new THREE.WebGLRenderer({antialias:true,alpha:true});renderer.setPixelRatio(1);renderer.setSize(innerWidth,innerHeight);renderer.xr.enabled=true;container.appendChild(renderer.domElement);reticle=new THREE.Mesh(new THREE.RingGeometry(0.15,0.2,32).rotateX(-Math.PI/2),new THREE.MeshBasicMaterial({color:0xffffff}));reticle.matrixAutoUpdate=false;reticle.visible=false;scene.add(reticle);controller=renderer.xr.getController(0);controller.addEventListener('select',onSelect);scene.add(controller);window.addEventListener('resize',()=>{camera.aspect=innerWidth/innerHeight;camera.updateProjectionMatrix();renderer.setSize(innerWidth,innerHeight);});renderer.domElement.addEventListener('touchstart',onTouchStart,{passive:false});renderer.domElement.addEventListener('touchmove',onTouchMove,{passive:false});renderer.domElement.addEventListener('touchend',onTouchEnd);setupVideo();renderer.setAnimationLoop(render);}function setupVideo(){videoElement=document.getElementById('video-source');const input=document.getElementById('video-input');input.addEventListener('change',(e)=>{const file=e.target.files[0];if(!file)return;elStatus.textContent='Loading...';videoElement.src=URL.createObjectURL(file);videoElement.onloadedmetadata=()=>{elStatus.textContent='Ready!';elStatus.className='success';videoAspect=videoElement.videoWidth/videoElement.videoHeight;videoHeight=1/videoAspect;elArBtn.innerHTML='';const button=ARButton.createButton(renderer,{requiredFeatures:['hit-test'],optionalFeatures:['dom-overlay'],domOverlay:{root:elSetup.parentElement}});button.addEventListener('click',()=>{elSetup.style.display='none';createMesh();});elArBtn.appendChild(button);};});}function createMesh(){const geom=new THREE.PlaneGeometry(1,videoHeight);geom.translate(0,videoHeight/2,0);geom.rotateX(-Math.PI/2);const mat=new THREE.MeshBasicMaterial({map:new THREE.VideoTexture(videoElement),side:THREE.DoubleSide});mat.map.colorSpace=THREE.SRGBColorSpace;videoMesh=new THREE.Mesh(geom,mat);videoMesh.visible=false;scene.add(videoMesh);}function detectSurface(m){const yAxis=new THREE.Vector3();yAxis.setFromMatrixColumn(m,1);return Math.abs(yAxis.y)>0.7?'floor':'wall';}function onSelect(){if(reticle.visible&&!isPlaced){surfaceType=detectSurface(reticle.matrix);videoMesh.position.setFromMatrixPosition(reticle.matrix);const q=new THREE.Quaternion();q.setFromRotationMatrix(reticle.matrix);videoMesh.quaternion.copy(q);if(surfaceType==='wall'){videoMesh.rotateX(Math.PI/2);}videoMesh.visible=true;isPlaced=true;videoElement.play();videoElement.muted=false;elFeedback.classList.remove('visible');elGesture.classList.add('visible');console.log('Placed:',surfaceType);}else if(isPlaced){tempMatrix.identity().extractRotation(controller.matrixWorld);raycaster.ray.origin.setFromMatrixPosition(controller.matrixWorld);raycaster.ray.direction.set(0,0,-1).applyMatrix4(tempMatrix);if(raycaster.intersectObject(videoMesh).length>0){videoElement.paused?videoElement.play():videoElement.pause();}}}function onTouchStart(e){if(e.touches.length===2&&isPlaced){e.preventDefault();pinching=true;const p0=e.touches[0],p1=e.touches[1];const dx=p0.clientX-p1.clientX,dy=p0.clientY-p1.clientY;touchDist0=Math.hypot(dx,dy);startScale=videoMesh.scale.x;lastRotZ=Math.atan2(dy,dx);console.log('PINCH START:',touchDist0);}}function onTouchMove(e){if(!isPlaced||!pinching||e.touches.length!==2)return;e.preventDefault();e.stopPropagation();const p0=e.touches[0],p1=e.touches[1];const dx=p0.clientX-p1.clientX,dy=p0.clientY-p1.clientY;const curr=Math.hypot(dx,dy);const scale=curr/touchDist0;const newS=Math.max(0.3,Math.min(startScale*scale,5));videoMesh.scale.setScalar(newS);const newAngle=Math.atan2(dy,dx);const rot=newAngle-lastRotZ;videoMesh.rotateZ(rot);lastRotZ=newAngle;console.log('Scale:',newS.toFixed(2));}function onTouchEnd(e){if(e.touches.length<2){pinching=false;console.log('PINCH END');}}function render(t,f){if(f){const sess=renderer.xr.getSession();if(!sess)return;const rs=renderer.xr.getReferenceSpace();if(!reticle.visible){sess.requestReferenceSpace('viewer').then(ref=>{sess.requestHitTestSource({space:ref}).then(src=>{if(!src)return;const hits=f.getHitTestResults(src);if(hits.length>0){reticle.visible=true;reticle.matrix.fromArray(hits[0].getPose(rs).transform.matrix);const t=detectSurface(reticle.matrix);elFeedback.textContent='TAP to place ('+t.toUpperCase()+')';elFeedback.classList.add('visible');}else{reticle.visible=false;}}).catch(()=>{});});}}}renderer.render(scene,camera);}</script></body></html>
